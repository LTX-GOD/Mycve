## Vulnerability Description

- **Repository:** [https://github.com/statamic/cms.git](https://github.com/statamic/cms.git)
- **Version:** latest (new / dev)
- **Type:** Stored Cross-Site Scripting (Stored XSS)

A low-privileged user with the `configure collections` permission can inject malicious SVG content into the `icon` field of a Collection. The value is later rendered in the Control Panel (CP) navigation without proper sanitization, leading to a stored XSS that triggers when an administrator views the CP.

---

## Relevant Code Locations

- **Authorization bypass (permission entry point)**
  `CollectionPolicy.php#L16`
  The `configure collections` permission is sufficient to modify collection configuration, including the `icon` field.

- **Dangerous value assignment**
  `CollectionsController.php#L328`

  ```php
  ->icon($values['icon'])
  ```

  The user-controlled `icon` value is stored without sanitization.

- **Navigation rendering usage**
  `CoreNav.php#L91`
  The stored icon value is used in CP navigation rendering.

- **Frontend rendering (unsafe SVG rendering)**
  `resources/js/components/ui/Icon/Icon.vue#L16`
  The `<svg>` content is rendered directly in the template, allowing event handlers such as `onload` to execute.

---

## Vulnerability Reproduction

### 1. Prepare a Test Environment

If you already have a Statamic site, you may skip this step.

```bash
composer create-project statamic/statamic statamic-lab
cd statamic-lab

composer config repositories.local-cms '{"type":"path","url":"/Users/zsm/Downloads/cms","options":{"symlink":true}}'
composer require statamic/cms:@dev

cp .env.example .env
php artisan key:generate
php artisan statamic:install
```

---

### 2. Enable Pro (Required to Create Multiple Users)

Statamic blocks additional user creation in non-Pro mode if a user already exists (see `MakeUser.php#L73`).

```bash
php artisan statamic:pro:enable --update-config
```

---

### 3. Create Test Accounts

```bash
php artisan statamic:make:user admin@example.test --password='Admin#123456' --super
php artisan statamic:make:user attacker@example.test --password='Attacker#123456'
```

Suggested roles:

| Role                     | Email                                                 | Password        | Permissions                       |
| ------------------------ | ----------------------------------------------------- | --------------- | --------------------------------- |
| Victim (Admin)           | [admin@example.test](mailto:admin@example.test)       | Admin#123456    | super                             |
| Attacker (Low-privilege) | [attacker@example.test](mailto:attacker@example.test) | Attacker#123456 | access cp + configure collections |

---

### 4. Assign Minimal Permissions to Attacker

```bash
php artisan tinker <<'PHP'
use Statamic\Facades\Role;
use Statamic\Facades\User;

$role = Role::find('xss_tester') ?: Role::make()->handle('xss_tester');
$role->title('XSS Tester')->permissions(['access cp','configure collections'])->save();

$u = User::findByEmail('attacker@example.test');
$u->assignRole('xss_tester')->save();
PHP
```

---

### 5. Start the Application

```bash
php artisan serve --host=127.0.0.1 --port=8000
```

---

## Exploitation Steps

1. Log in as the attacker:
   `http://127.0.0.1:8000/cp`

2. Navigate to any Collection edit page (e.g., **Pages**).

3. Intercept the save request using Burp or a proxy tool.

4. Modify the `icon` field to:

```html
<svg
  xmlns="http://www.w3.org/2000/svg"
  onload="alert('XSS:'+document.domain)"
></svg>
```

5. Send the modified request.

6. Log in as the administrator in another browser (or log out/in).

7. Visit `/cp` or refresh the Control Panel sidebar.

8. The alert dialog will trigger, confirming successful stored XSS.

---
